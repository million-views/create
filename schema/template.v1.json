{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.million-views.dev/create/template.v1.json",
  "title": "Template Manifest V1.0 (Registry + UI)",
  "description": "Defines a template's infrastructure stack, feature bundles, and configuration variables.",
  "type": "object",
  "required": [
    "schemaVersion",
    "id",
    "placeholderFormat",
    "placeholders"
  ],
  "properties": {
    "schemaVersion": {
      "type": "string",
      "const": "1.0.0",
      "description": "Must be exactly 1.0.0"
    },
    "id": {
      "type": "string",
      "pattern": "^[a-z0-9-]+/[a-z0-9-]+$",
      "description": "Unique identifier (e.g., author/template-name)"
    },
    "name": {
      "type": "string",
      "maxLength": 120
    },
    "description": {
      "type": "string",
      "maxLength": 500
    },
    "status": {
      "type": "string",
      "enum": [
        "draft",
        "published",
        "deprecated"
      ],
      "default": "published",
      "description": "Template lifecycle status for registry filtering. draft=testing/iteration, published=ready for use, deprecated=migrate away"
    },
    "placeholderFormat": {
      "type": "string",
      "enum": [
        "unicode",
        "mustache",
        "dollar",
        "percent"
      ],
      "default": "unicode",
      "description": "Delimiter format used for placeholders in template files. Set by 'create template convert --placeholder-format'."
    },
    "placeholders": {
      "type": "object",
      "description": "THE REGISTRY. Populated by 'create template convert'. A flat dictionary of all variables.",
      "patternProperties": {
        "^[A-Z0-9_]+$": {
          "type": "object",
          "required": [
            "description"
          ],
          "properties": {
            "description": {
              "type": "string"
            },
            "default": {
              "type": [
                "string",
                "number",
                "boolean"
              ]
            },
            "type": {
              "type": "string",
              "enum": [
                "text",
                "number",
                "boolean",
                "email",
                "password",
                "url"
              ],
              "default": "text"
            },
            "required": {
              "type": "boolean",
              "default": true
            },
            "secure": {
              "type": "boolean",
              "default": false
            }
          },
          "additionalProperties": false
        }
      }
    },
    "dimensions": {
      "type": "object",
      "description": "Infrastructure choices (Stack). Fixed vocabulary of 7 dimensions.",
      "properties": {
        "deployment": {
          "$ref": "#/$defs/dimensionDef",
          "description": "WHERE it runs (e.g., cloudflare-workers, deno-deploy)"
        },
        "database": {
          "$ref": "#/$defs/dimensionDef",
          "description": "HOW data persists (e.g., d1, sqlite, postgres)"
        },
        "storage": {
          "$ref": "#/$defs/dimensionDef",
          "description": "HOW files persist (e.g., r2, local, spaces)"
        },
        "identity": {
          "$ref": "#/$defs/dimensionDef",
          "description": "WHO can access (e.g., github, google, email)"
        },
        "billing": {
          "$ref": "#/$defs/dimensionDef",
          "description": "HOW revenue flows (e.g., stripe, paddle)"
        },
        "analytics": {
          "$ref": "#/$defs/dimensionDef",
          "description": "WHAT users do - business metrics (e.g., cf-analytics, umami)"
        },
        "monitoring": {
          "$ref": "#/$defs/dimensionDef",
          "description": "HOW system behaves - ops metrics (e.g., cf-logs, sentry)"
        }
      },
      "additionalProperties": false
    },
    "features": {
      "type": "array",
      "description": "Author-defined feature bundles. Each feature declares infrastructure requirements via 'needs'.",
      "items": {
        "type": "object",
        "required": [
          "id",
          "label",
          "needs"
        ],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^[a-z0-9_-]+$",
            "description": "Unique feature identifier"
          },
          "label": {
            "type": "string",
            "description": "Human-readable feature name"
          },
          "description": {
            "type": "string",
            "description": "Brief description of the feature"
          },
          "icon": {
            "type": "string",
            "description": "Icon identifier for UI display"
          },
          "needs": {
            "$ref": "#/$defs/capabilityNeeds",
            "description": "Infrastructure requirements for this feature"
          },
          "placeholders": {
            "$ref": "#/$defs/placeholderRefList",
            "description": "Configuration variables required by this feature"
          }
        }
      }
    },
    "gates": {
      "type": "object",
      "description": "Compatibility rules between dimensions. Keyed by dimension name, then option ID.",
      "properties": {
        "deployment": {
          "$ref": "#/$defs/gateDef"
        },
        "database": {
          "$ref": "#/$defs/gateDef"
        },
        "storage": {
          "$ref": "#/$defs/gateDef"
        },
        "identity": {
          "$ref": "#/$defs/gateDef"
        },
        "billing": {
          "$ref": "#/$defs/gateDef"
        },
        "analytics": {
          "$ref": "#/$defs/gateDef"
        },
        "monitoring": {
          "$ref": "#/$defs/gateDef"
        }
      },
      "additionalProperties": false
    },
    "setup": {
      "type": "object",
      "description": "Setup script configuration and authoring options.",
      "properties": {
        "script": {
          "type": "string",
          "default": "_setup.mjs",
          "description": "Setup script filename. Must export a default async function accepting ({ctx, tools})."
        },
        "authoringMode": {
          "type": "string",
          "enum": [
            "composable",
            "wysiwyg"
          ],
          "default": "composable",
          "description": "composable=features assembled via setup script, wysiwyg=visual editor with pre-built combinations"
        },
        "authorAssetsDir": {
          "type": "string",
          "default": "__scaffold__",
          "description": "Directory containing author assets (snippets, partials) for conditional copying. Removed after scaffolding."
        }
      },
      "additionalProperties": false
    }
  },
  "$defs": {
    "dimensionDef": {
      "type": "object",
      "required": [
        "options"
      ],
      "properties": {
        "label": {
          "type": "string",
          "description": "Header label in the UI"
        },
        "policy": {
          "type": "string",
          "enum": [
            "strict",
            "warn"
          ],
          "default": "strict",
          "description": "Validation policy. strict=reject unknown values, warn=allow with warning"
        },
        "display": {
          "type": "object",
          "properties": {
            "variant": {
              "enum": [
                "card-grid",
                "list-selection",
                "dropdown"
              ],
              "default": "list-selection"
            },
            "icon": {
              "type": "string"
            }
          }
        },
        "default": {
          "type": "string",
          "description": "Default option ID"
        },
        "options": {
          "type": "array",
          "items": {
            "type": "object",
            "required": [
              "id"
            ],
            "properties": {
              "id": {
                "type": "string",
                "pattern": "^[a-z0-9-]+$",
                "description": "Option identifier (e.g., cloudflare-workers, postgres)"
              },
              "label": {
                "type": "string",
                "description": "Human-readable option name"
              },
              "desc": {
                "type": "string",
                "description": "Brief description"
              },
              "icon": {
                "type": "string"
              },
              "placeholders": {
                "$ref": "#/$defs/placeholderRefList"
              }
            }
          }
        }
      }
    },
    "gateDef": {
      "type": "object",
      "description": "Constraints for each option in this dimension",
      "patternProperties": {
        "^[a-z0-9-]+$": {
          "type": "object",
          "description": "When this option is selected, restrict other dimensions",
          "properties": {
            "database": {
              "type": "array",
              "items": { "type": "string" }
            },
            "storage": {
              "type": "array",
              "items": { "type": "string" }
            },
            "identity": {
              "type": "array",
              "items": { "type": "string" }
            },
            "billing": {
              "type": "array",
              "items": { "type": "string" }
            },
            "analytics": {
              "type": "array",
              "items": { "type": "string" }
            },
            "monitoring": {
              "type": "array",
              "items": { "type": "string" }
            }
          },
          "additionalProperties": false
        }
      }
    },
    "placeholderKey": {
      "type": "string",
      "pattern": "^[A-Z0-9_]+$",
      "description": "A reference to a key in the placeholders registry."
    },
    "placeholderRefList": {
      "type": "array",
      "description": "List of placeholder keys (from registry) required by this item.",
      "items": {
        "$ref": "#/$defs/placeholderKey"
      },
      "uniqueItems": true
    },
    "capabilityNeeds": {
      "type": "object",
      "description": "Infrastructure requirements. Keys are dimension names, values indicate requirement level.",
      "properties": {
        "deployment": {
          "$ref": "#/$defs/requirementLevel"
        },
        "database": {
          "$ref": "#/$defs/requirementLevel"
        },
        "storage": {
          "$ref": "#/$defs/requirementLevel"
        },
        "identity": {
          "$ref": "#/$defs/requirementLevel"
        },
        "billing": {
          "$ref": "#/$defs/requirementLevel"
        },
        "analytics": {
          "$ref": "#/$defs/requirementLevel"
        },
        "monitoring": {
          "$ref": "#/$defs/requirementLevel"
        }
      },
      "additionalProperties": false
    },
    "requirementLevel": {
      "type": "string",
      "enum": [
        "required",
        "optional",
        "none"
      ],
      "description": "Whether this infrastructure capability is required, optional, or not needed"
    }
  }
}