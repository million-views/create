---
title: "Template System Architecture Explained"
description: "Git-based template system architecture for project scaffolding"
type: explanation
audience: "intermediate"
estimated_time: "10 minutes read"
prerequisites:
  - "Understanding of git repositories and file systems"
  - "Basic knowledge of Node.js and CLI tools"
related_docs:
  - "../tutorial/create-scaffold.md"
  - "../how-to/creating-templates.md"
  - "../reference/environment.md"
  - "../how-to/setup-recipes.md"
last_updated: "2025-11-14"
---

# Template System Architecture Explained

## Introduction

@m5nv/create-scaffold implements a git-based template system that balances simplicity with template-driven customization. The architecture separates template discovery, processing, and customization while maintaining security and reliability. Understanding this approach helps template authors and maintainers troubleshoot issues.

## The Problem

Traditional project scaffolding approaches face several challenges:

- **Rigid Structure**: Templates are often inflexible and hard to customize
- **Version Management**: Keeping templates updated and synchronized is difficult
- **Distribution**: Sharing templates requires complex packaging and distribution systems
- **IDE Integration**: Templates don't adapt to different development environments
- **Setup Complexity**: Post-scaffolding setup often requires manual intervention

## Our Approach

We built a git-native template system that leverages existing developer workflows and tools while adding intelligent customization capabilities.

### Key Principles

1. **Git-Native**: Templates are standard git repositories, no special packaging required
2. **Convention over Configuration**: Sensible defaults with opt-in customization
3. **Environment Awareness**: Templates can adapt to different IDEs and development contexts
4. **Composable**: Templates can include multiple variants and options
5. **Secure by Design**: Template processing respects security boundaries

## How It Works

### Template Discovery and Resolution

The system supports multiple template sources with a unified resolution process:

```text
Template Resolution Flow:
User Input â†’ Validation â†’ Source Detection â†’ Repository Access â†’ Template Location
```

**Source Types:**
- **Registry Aliases**: `registry/template-name` â†’ resolves to configured URL via `.m5nvrc`
- **GitHub Shorthand**: `user/repo` â†’ `https://github.com/user/repo.git`
- **Full URLs**: `https://github.com/user/repo.git`
- **Local Paths**: `./my-template` or `/absolute/path/to/template`
- **Branch Specification**: Any source can include `#branch-name`

**Template Location:**
- **Root Templates**: Template files directly in repository root
- **Named Templates**: Templates in subdirectories (e.g., `basic/`, `advanced/`)
- **Nested Templates**: Multi-level template organization

### Repository Processing Pipeline

```text
Repository â†’ Clone/Cache â†’ Template Discovery â†’ Validation â†’ Processing â†’ Cleanup
```

1. **Repository Access**: Clone or access cached repository
2. **Template Discovery**: Locate specified template within repository
3. **Structure Validation**: Verify template has required structure
4. **File Processing**: Copy and process template files
5. **Setup Execution**: Run optional setup scripts with user consent
6. **Cleanup**: Remove temporary files and caches as needed

### Template Structure

Templates follow a simple but flexible structure:

```console
template-repository/
â”œâ”€â”€ README.md                 # Template documentation
â”œâ”€â”€ package.json             # Optional: npm package metadata
â”œâ”€â”€ template.json            # Template metadata and configuration (required)
â”œâ”€â”€ _setup.mjs               # Optional: post-scaffolding setup script
â”œâ”€â”€ .gitignore              # Standard git ignore patterns
â”œâ”€â”€ src/                    # Template content
â”‚   â”œâ”€â”€ index.js
â”‚   â””â”€â”€ utils/
â””â”€â”€ docs/                   # Template documentation
```

**Special Files:**
- **`template.json`**: Template metadata and configuration file (required). Defines template schema version, placeholders, dimensions, features, and other template characteristics. Generated by `make-template` commands and validated by `create-scaffold`.
- **`_setup.mjs`**: Optional post-scaffolding automation script executed inside a secure Node.js VM sandbox with restricted capabilities. The sandbox blocks Node built-ins (`fs`, `path`, `import`, `require`, `eval`) but provides access to `console`, timers, and `process.env`. Scripts must export `default async function setup({ ctx, tools })` and use the curated helper toolkit for all filesystem operations and project modifications.
- **`README.md`**: Template documentation and usage instructions
- **`.gitignore`**: Patterns for files to exclude during scaffolding
- **`.template-undo.json`**: Generated by tooling for local template development and automatically ignored by `create-scaffold` during copy, dry-run reports, and setup helper operations.

### Environment

The Environment object provides templates with context about the scaffolding operation:

```javascript
export default async function setup({ ctx, tools }) {
  await tools.placeholders.replaceAll(
    { PROJECT_NAME: ctx.projectName },
    ['README.md', 'package.json']
  );

  await tools.text.ensureBlock({
    file: 'README.md',
    marker: '# {{PROJECT_NAME}}',
    block: ['## Getting Started', '- npm install', '- npm run dev']
  });

  await tools.json.set('package.json', 'scripts.dev', 'vite dev');

  // Copy IDE configurations from template
  await tools.templates.copy('.vscode', '.vscode');
}
```

Setup scripts run in a resource-restricted sandbox and rely exclusively on the curated helper library (`tools.placeholders`, `tools.inputs`, `tools.text`, `tools.json`, `tools.files`, `tools.options`, `tools.templates`, `tools.logger`). Refer to the [Environment Reference](../reference/environment.md) and the [Setup Script Recipes how-to](../how-to/setup-recipes.md) for a complete catalogue of helper capabilities.
**Design Rationale:**
- **Immutable**: Prevents accidental modification during setup
- **Validated**: All values are security-validated before creation
- **Contextual**: Provides both project and environment information
- **Extensible**: Can be enhanced with additional context in future versions

## Design Decisions

### Decision 1: Git-Native Template Storage

**Why we chose this:** Git repositories are already familiar to developers and provide built-in versioning, branching, and distribution.

**Trade-offs:**
- **Gained**: Familiar workflow, built-in versioning, easy sharing, branch-based variants
- **Given up**: Some performance optimizations possible with custom formats

**Alternatives considered:**
- **npm packages** (rejected - adds packaging complexity and npm-specific dependencies)
- **Custom archive format** (rejected - requires special tooling and distribution)
- **Centralized registry system** (rejected - adds infrastructure complexity and gatekeeper control)
- **Local registry aliases** (implemented - provides convenient shortcuts without centralization)

### Decision 2: Optional Setup Scripts

**Why we chose this:** Many templates need post-scaffolding customization, but security requires user consent.

**Trade-offs:**
- **Gained**: Powerful automation capabilities while maintaining security
- **Given up**: Fully automated setup (user must consent to script execution)

**Alternatives considered:**
- **Mandatory setup scripts** (rejected - security risk)
- **No setup scripts** (rejected - limits template capabilities)
- **Declarative configuration only** (rejected - insufficient for complex setup needs)

### Decision 3: Template Discovery by Convention

**Why we chose this:** Templates can be organized hierarchically without requiring manifest files.

**Trade-offs:**
- **Gained**: Simple organization, no metadata files required, intuitive structure
- **Given up**: Some advanced metadata capabilities

**Alternatives considered:**
- **Manifest-based discovery** (rejected - adds complexity and maintenance burden)
- **Single template per repository** (rejected - limits organization flexibility)

### Decision 4: Caching with Validation

**Why we chose this:** Caching improves performance while validation prevents corruption.

**Trade-offs:**
- **Gained**: Fast repeated access, corruption detection, configurable TTL
- **Given up**: Some disk space, complexity in cache management

**Alternatives considered:**
- **No caching** (rejected - poor performance for repeated operations)
- **Simple caching without validation** (rejected - corruption risk)
- **Network-only validation** (rejected - requires network access for cached operations)

## Implementation Architecture

### Core Components

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CLI Parser    â”‚â”€â”€â”€â–¶â”‚  Preflight       â”‚â”€â”€â”€â–¶â”‚  Template       â”‚
â”‚                 â”‚    â”‚  Validation      â”‚    â”‚  Processor      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚                        â”‚
                                â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Security      â”‚â—€â”€â”€â”€â”‚  Input           â”‚    â”‚  Environment    â”‚
â”‚   Validation    â”‚    â”‚  Sanitization    â”‚    â”‚  Factory        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                         â”‚
                                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Cache         â”‚â—€â”€â”€â”€â”‚  Repository      â”‚â”€â”€â”€â–¶â”‚  Setup Script   â”‚
â”‚   Manager       â”‚    â”‚  Handler         â”‚    â”‚  Executor       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow

1. **Input Processing**: CLI arguments â†’ validation â†’ sanitization
2. **Repository Resolution**: Template source â†’ repository access â†’ template location
3. **Template Processing**: Template files â†’ project directory â†’ file operations
4. **Environment Creation**: Context gathering â†’ `ctx` object â†’ setup script
5. **Cleanup**: Temporary files â†’ cache management â†’ completion

### Error Handling Strategy

- **Early Validation**: Catch issues before expensive operations
- **Graceful Degradation**: Continue with reduced functionality when possible
- **Clean Failure**: Remove partial state on errors
- **Informative Messages**: Provide actionable error information
- **Security-First**: Sanitize error messages to prevent information disclosure

## Implications

### For Template Authors

- **Simple Structure**: No complex manifest files or special packaging required
- **Git Workflow**: Use standard git operations for versioning and distribution
- **Flexible Organization**: Organize templates hierarchically within repositories
- **Curated Setup Tools**: Apply text, JSON, file, IDE, and templating helpers without importing Node built-ins or third-party code
- **Environment Awareness**: Adapt scaffolds using `ctx.options`, `ctx.constants`, and other contextual data

### For Users

- **Familiar Sources**: Use any git repository as a template source
- **Branch Support**: Access different template versions via git branches
- **Caching Benefits**: Repeated operations are fast due to intelligent caching
- **Security Assurance**: Template processing respects security boundaries
- **IDE Integration**: Templates can customize based on your development environment

### For the Ecosystem

- **Low Barrier to Entry**: Anyone can create templates using existing git knowledge
- **Decentralized**: No central registry or infrastructure required
- **Interoperable**: Templates work with standard git hosting and workflows
- **Extensible**: Architecture supports future enhancements without breaking changes

## Limitations

Current architectural limitations that users should understand:

1. **Git Dependency**: Requires git to be installed and accessible
2. **Network Requirements**: Remote templates require network access (unless cached)
3. **Setup Script Language**: Setup scripts must be written in JavaScript/Node.js
4. **File-Based Templates**: Cannot generate files dynamically during scaffolding
5. **Single Template per Operation**: Cannot compose multiple templates in one operation

## Future Considerations

### Planned Enhancements

- **Template Composition**: Combine multiple templates in a single operation
- **Dynamic File Generation**: Generate files based on user input during scaffolding
- **Template Validation**: Automated validation of template structure and content
- **Metadata System**: Optional manifest files for advanced template features

### Research Areas

- **Multi-Language Setup**: Support for setup scripts in other languages
- **Streaming Processing**: Process large templates without full download
- **Incremental Updates**: Update existing projects with template changes
- **Template Analytics**: Usage tracking and optimization insights

## Related Concepts

- **Security Model**: How security integrates with template processing
- **Caching Strategy**: How template caching improves performance and reliability
- **IDE Integration Philosophy**: How templates adapt to different development environments

## Further Reading

- ğŸ“š [create-scaffold Tutorial](../tutorial/create-scaffold.md) - Create your first project
- ğŸ› ï¸ [Creating Templates Guide](../how-to/creating-templates.md) - Comprehensive template creation guide
- ğŸ“– [Environment Reference](../reference/environment.md) - Complete `ctx` and `tools` documentation
