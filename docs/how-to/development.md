---
title: "Development Guide"
type: "guide"
audience: "advanced"
estimated_time: "30 minutes setup, reference thereafter"
prerequisites:
  - "Modern Node.js development experience (latest LTS)"
  - "Git and npm familiarity"
  - "Command line proficiency"
related_docs:
  - "../../CONTRIBUTING.md"
  - "../guides/troubleshooting.md"
  - "../reference/cli-reference.md"
last_updated: "2025-11-28"
---

# Development Guide

Complete guide for developing and testing @m5nv/create locally.

## Quick Start

```bash
# Clone the repository
git clone https://github.com/million-views/create.git
cd create

# Install development dependencies
npm install

# Run tests to verify setup
npm test

# Test CLI locally
node bin/create/index.mts --help
node bin/create/index.mts scaffold --help
node bin/create/index.mts template --help

# Optional: expose the create binary globally
npm link
create scaffold new scratch-app react-vite
npm unlink -g @m5nv/create
```

> Note: Template repositories now include a `.template-undo.json` file generated by the template commands. Keep this file checked inâ€”it supports template authors during local iterationsâ€”but `@m5nv/create` automatically ignores it during copying, dry runs, and setup runtime operations.

## Codebase Architecture

### Module Organization

The codebase follows a modular architecture with clear separation of concerns:

```console
create/
â”œâ”€â”€ bin/                              # CLI command entry points
â”‚   â””â”€â”€ create/                       # Unified CLI entry point
â”‚       â”œâ”€â”€ index.mts                 # Main CLI router
â”‚       â””â”€â”€ domains/                  # Domain-specific implementations
â”‚           â”œâ”€â”€ scaffold/             # Scaffold domain
â”‚           â”‚   â”œâ”€â”€ router.mts        # Scaffold command router
â”‚           â”‚   â”œâ”€â”€ commands/         # Individual scaffold subcommands
â”‚           â”‚   â”‚   â”œâ”€â”€ new/          # Project creation command
â”‚           â”‚   â”‚   â”œâ”€â”€ list/         # Template listing command
â”‚           â”‚   â”‚   â””â”€â”€ validate/     # Template validation command
â”‚           â”‚   â””â”€â”€ modules/          # Shared scaffold modules
â”‚           â”‚       â”œâ”€â”€ cache-manager.mts # Template repository caching
â”‚           â”‚       â”œâ”€â”€ config-loader.mts # Configuration file loading
â”‚           â”‚       â”œâ”€â”€ dry-run-engine.mts # Preview mode operations
â”‚           â”‚       â”œâ”€â”€ guided-setup-workflow.mts # Interactive setup flow
â”‚           â”‚       â”œâ”€â”€ options-processor.mts # CLI argument processing
â”‚           â”‚       â”œâ”€â”€ placeholder-resolver.mts # Template variable substitution
â”‚           â”‚       â”œâ”€â”€ registry/     # Template registry management
â”‚           â”‚       â”œâ”€â”€ security.mts  # Input validation and security
â”‚           â”‚       â”œâ”€â”€ setup-runtime.mts # Template setup script execution
â”‚           â”‚       â”œâ”€â”€ template-resolver.mts # Template discovery and loading
â”‚           â”‚       â””â”€â”€ validators/   # Input validation utilities
â”‚           â””â”€â”€ template/             # Template domain
â”‚               â”œâ”€â”€ router.mts        # Template command router
â”‚               â””â”€â”€ commands/         # Template subcommands
â”‚                   â”œâ”€â”€ init/         # Initialize template configuration
â”‚                   â”œâ”€â”€ convert/      # Project-to-template conversion
â”‚                   â”œâ”€â”€ restore/      # Template-to-project restoration
â”‚                   â”œâ”€â”€ validate/     # Template validation
â”‚                   â”œâ”€â”€ hints/        # Authoring hints display
â”‚                   â””â”€â”€ test/         # Template testing
â”œâ”€â”€ lib/                              # Shared library code
â”‚   â”œâ”€â”€ cli/                          # CLI framework (BaseCommand, Router)
â”‚   â”œâ”€â”€ error/                        # Error handling infrastructure
â”‚   â”œâ”€â”€ security/                     # Security validation
â”‚   â”œâ”€â”€ template/                     # Template processing
â”‚   â”œâ”€â”€ placeholder/                  # Placeholder resolution
â”‚   â”œâ”€â”€ templatize/                   # Templatization engine
â”‚   â””â”€â”€ validation/                   # Input validation
â”œâ”€â”€ docs/                             # User and developer documentation
â”œâ”€â”€ tests/                            # Comprehensive test suites
â”‚   â”œâ”€â”€ scaffold/                     # Scaffold domain tests
â”‚   â”œâ”€â”€ template/                     # Template domain tests
â”‚   â”œâ”€â”€ e2e/                          # End-to-end tests
â”‚   â””â”€â”€ lib/                          # Library tests
â”œâ”€â”€ scripts/                          # Development and testing utilities
â””â”€â”€ .kiro/specs/                      # Feature specifications and design docs
```

### Core Design Principles

**Zero Dependencies**: The project uses only Node.js built-in modules to minimize attack surface and ensure reliability.

**Security First**: All user inputs are validated and sanitized. No external code execution without explicit user consent.

**ES Modules Only**: Modern JavaScript patterns throughout, with `type: "module"` in package.json.

**Test-Driven Development**: Comprehensive test coverage across multiple specialized test suites.

### Key Modules

#### CLI Entry Point

**Create Router (`bin/create/index.mts`)**:
- Unified entry point for all CLI commands
- Routes to scaffold or template domain based on first argument
- Orchestrates argument parsing, validation, and command dispatch
- Manages error handling and user feedback

#### Domain Routers

**Scaffold Router (`bin/create/domains/scaffold/router.mts`)**:
- Handles scaffold subcommands: new, list, validate
- Coordinates between subcommands and shared modules

**Template Router (`bin/create/domains/template/router.mts`)**:
- Handles template subcommands: init, convert, restore, validate, hints, test, config
- Manages template authoring and conversion workflows

#### Core Modules

**Options Processor (`bin/create/domains/scaffold/modules/options-processor.mts`)**:
- Processes and validates CLI arguments using native `util.parseArgs`
- Supports all CLI options: `--help`, `--log-file`, `--dry-run`, `--no-cache`, `--yes`, `--cache-ttl`
- Provides comprehensive help text and usage information

**Guided Setup Workflow (`bin/create/domains/scaffold/modules/guided-setup-workflow.mts`)**:
- Drives the interactive prompt workflow for template selection and input capture
- Coordinates repository caching, catalog formatting, and placeholder prompts
- Returns normalized arguments that continue through the CLI pipeline

**Security Module (`lib/security/gate.mts`)**:
- Validates all user inputs for security compliance
- Prevents path traversal attacks (`../` sequences)
- Blocks command injection in repository URLs and branch names
- Sanitizes error messages to prevent information disclosure

**Cache Manager (`bin/create/domains/scaffold/modules/cache-manager.mts`)**:
- Manages local template repository caching in `~/.m5nv/cache`
- Implements TTL-based cache expiration (24-hour default)
- Provides cache bypass with `--no-cache` flag
- Handles cache corruption recovery automatically

**Template Resolver (`bin/create/domains/scaffold/modules/template-resolver.mts`)**:
- Handles template discovery and loading from various sources
- Supports local paths, git repositories, and registry lookups
- Manages template metadata parsing and validation
- Coordinates with cache manager for performance optimization

**Setup Runtime (`bin/create/domains/scaffold/modules/setup-runtime.mts`)**:
- Executes template setup scripts in isolated environments
- Manages environment variable injection and script sandboxing
- Handles setup script failures gracefully with user feedback
- Ensures cleanup of temporary resources and artifacts

## Configuration Defaults

The CLI can bootstrap defaults from configuration files so repetitive flags are
optional during local development.

### Discovery order

1. Project-level `.m5nvrc` in your working directory.
2. User config: `~/.m5nv/rc.json` (or `$M5NV_HOME/rc.json` when M5NV_HOME is set).

Run with `--no-config` to skip discovery entirely. This is useful when testing
error scenarios or validating the base CLI behavior.

### Schema

Configuration files are UTF-8 JSON objects supporting the fields below:

```json
{
  "repo": "owner/templates",
  "branch": "main",
  "author": {
    "name": "Example Dev",
    "email": "dev@example.com",
    "url": "https://example.com"
  },
  "placeholders": {
    "PROJECT_NAME": "demo-app",
    "API_TOKEN": "example-token"
  }
}
```

- `repo` and `branch` seed CLI defaults when CLI flags are omitted.
- `author` metadata becomes available to setup scripts via the environment
  object (values are masked in logs).
- `placeholders` behave like `--placeholder` but with lower precedence than
  environment variables and CLI overrides.

Validation errors reference the offending path and instruct you to re-run with
`--no-config` if you need to bypass a broken file temporarily.

## Testing Strategy

The project follows a **testing pyramid** architecture that provides maximum confidence with optimal efficiency.

### Testing Pyramid Structure

| Level | Command | Purpose | Confidence Level | Speed |
|-------|---------|---------|------------------|-------|
| **Unit** | `npm run test:unit` | Core components & infrastructure | **Foundation** | âš¡ Fast |
| **Integration** | `npm run test:integration` | Command-level functionality | **Feature** | ğŸš€ Medium |
| **System** | `npm run test:system` | Full end-to-end workflows | **Production** | ğŸŒ Slow |

### Test Level Details

#### Unit Tests (`npm run test:unit`)
**Purpose**: Validate core components and infrastructure work correctly in isolation.

**Covers**:
- Security Tests: Input validation and attack prevention
- Template Validator: Schema validation and manifest processing
- Base Command: Command framework and argument parsing
- Router: Command dispatch and routing logic

**When to run**: During active development, after any infrastructure changes.

#### Integration Tests (`npm run test:integration`)
**Purpose**: Validate that individual CLI commands work end-to-end with file system operations.

**Covers**:
- Scaffold New: Project creation with templates
- Scaffold List: Template listing and discovery
- Scaffold Validate: Template validation commands
- Template Init: Template skeleton generation
- Template Hints: Authoring guidance display
- Template Convert: Project-to-template conversion
- Template Restore: Template-to-project restoration
- Template Test: Template testing integration
- Template Validate: Template validation and compliance

**When to run**: After command changes, during feature development.

#### System Tests (`npm run test:system`)
**Purpose**: Validate complete system behavior under realistic conditions with resource management.

**Covers**:
- Functional Tests: Comprehensive end-to-end CLI behavior
- Resource Leak Tests: Memory, file handle, and temporary directory cleanup

**When to run**: Before releases, for production readiness validation.

### Testing Methodology

**Test-First Development**: All functionality developed using strict TDD:

1. Write failing tests that define expected behavior
2. Implement minimal code to make tests pass
3. Refactor while maintaining green tests
4. Validate with appropriate test pyramid level

**Security Testing**: Every security feature thoroughly tested:

- Path traversal prevention with malicious inputs
- Command injection blocking with crafted payloads
- Input validation with edge cases and boundary conditions
- Error message sanitization to prevent information disclosure

## Testing the CLI Locally

### 1. Direct Node Execution (Development)

Test changes immediately without installation:

```bash
# Test CLI directly during development
node bin/create/index.mts --help
node bin/create/index.mts scaffold --help
node bin/create/index.mts scaffold new my-test-app --template react-vite
node bin/create/index.mts scaffold list

# Test template commands
node bin/create/index.mts template --help
node bin/create/index.mts template init
```

### 2. npm link (Global Binary)

Creates global symlinks for the `create` binary:

```bash
# Link your local package globally
npm link

# Run the CLI via the linked binary
create scaffold new my-test-app --template react-vite
create scaffold list
create template init
create template convert --dry-run

# Cleanup when done
npm unlink -g @m5nv/create
```

### 3. Local Installation (Production Simulation)

Install your local version globally to simulate a published install:

```bash
# Install from current directory
npm install -g .

# Use normally
create scaffold new my-app --template some-template
create template init

# Uninstall when done
npm uninstall -g @m5nv/create
```

## Running Tests

### Testing Pyramid Commands

```bash
# Complete test suite (all pyramid levels)
npm test

# Individual pyramid levels
npm run test:unit         # Foundation: Core components & infrastructure
npm run test:integration  # Feature: Command-level functionality
npm run test:system       # Production: Full end-to-end workflows

# Domain-specific test groups
npm run test:scaffold     # All scaffold related tests
npm run test:template     # All template related tests

# Code quality
npm run lint              # Zero warnings required
```

### Development Testing Workflow

**During Active Development** (Fast feedback loop):
```bash
npm run test:unit         # Quick validation of core changes
npm run test:integration  # Validate command functionality
```

**Before Commits** (Feature validation):
```bash
npm run test:integration  # Ensure commands work end-to-end
npm run lint              # Check code quality
```

**Before Release** (Production readiness):
```bash
npm test                  # Full test suite
```

## See Also

- [Contributing Guide](../../CONTRIBUTING.md) - Contribution guidelines
- [CLI Reference](../reference/cli-reference.md) - Complete command documentation
- [Troubleshooting Guide](../guides/troubleshooting.md) - Common issues and solutions
